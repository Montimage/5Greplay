<beginning>

<!-- 
This rule set MAC protocol via user inputs:
- mac-src
- mac-dst
- mac-proto
 -->

<embedded_functions><![CDATA[
/* Basic Ethernet header structure (14 bytes) */
typedef struct  {
	uint8_t dst[6];
	uint8_t src[6];
	uint16_t type;
} eth_t;

static eth_t ethernet;

static inline void  _get_mac(uint8_t *mac, const char* name){
	const char *val;
	val = get_input( name );
	if( !val )
		return;
	
	int m[6];
	sscanf(val, "%x:%x:%x:%x:%x:%x", m+0, m+1, m+2, m+3, m+4, m+5);
	for(int i=0; i<6; i++)
		mac[i] = m[i];
}

static inline void _set_proto(){
	const char *val = get_input("mac-proto");
	if( val )
		ethernet.type = htons(atoi(val));
}

void on_load(){
	memset(&ethernet, 0, sizeof(ethernet));
	
	_get_mac(ethernet.src, "mac-src");
	_get_mac(ethernet.dst, "mac-dst");
	_set_proto();
}



static void em_replace_ethernet(
		const rule_info_t *rule, int verdict, uint64_t timestamp, 
		uint64_t counter, const mmt_array_t * const trace ){

	replace_data_at_protocol_id( PROTO_ETHERNET, sizeof(ethernet), (const char *) &ethernet );
	forward_packet();
}
]]></embedded_functions>

<property property_id="100" type_property="FORWARD" 
    description="Set new Ethernet"
    if_satisfied="em_replace_ethernet">
    <event description="Got a packet having Ethernet"
           boolean_expression="(ethernet.proto != 0)"/>
</property>

</beginning>